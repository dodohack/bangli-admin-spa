<editor-page-header [slug]="'post'"
                    [name]="'文章'"
                    [zh]="zh"
                    [previewUrl]="previewUrl"
                    [ids]="idsCurPage$ | async"
                    [entities]="entities$ | async"
                    [entity]="entity$ | async"
                    (cancelEdit)="cancelSave()">
</editor-page-header>


<entity-buttons [entityState]="(entity$ | async)?.state"
                (save)="save()"
                (save2Pending)="save2Pending()"
                (save2Draft)="save2Draft()"
                (save2Publish)="save2Publish()"
                (cancelSave)="cancelSave()">
</entity-buttons>

<entity-title-date [title]="(entity$ | async)?.title"
                   [date]="(entity$ | async)?.fake_published_at"
                   (titleChange)="updateTitle($event)"
                   (dateChange)="updateFakePublishedAt($event)">
</entity-title-date>

<!-- Post location, category, tag, topic etc -->

<entity-attr-cloud [categories]="(entity$ | async)?.categories"
                   [topics]="(entity$ | async)?.topics"
                   [locations]="(entity$ | async)?.locations"
                   (toggle)="tabIdx = $event; openPanel = !openPanel"
                   (deleteCat)="removeCat($event)"
                   (deleteTag)="removeTag($event)"
                   (deleteTopic)="removeTopic($event)"
                   (toggleGeoLocation)="updateGeoLocation($event)">
</entity-attr-cloud>

<entity-attributes [authorId]="(entity$ | async)?.author_id"
                   [editorId]="(entity$ | async)?.editor_id"
                   [creativeType]="(entity$ | async)?.creative_type"
                   [channelId]="(entity$ | async)?.channel_id"
                   [authors]="authors$ | async"
                   [editors]="editors$ | async"
                   [creativeTypes]="creativeTypes"
                   [channels]="cmsChannels$ | async"
                   (authorChanged)="updateAuthor($event)"
                   (editorChanged)="updateEditor($event)"
                   (creativeTypeChanged)="updateCreativeType($event)"
                   (channelChanged)="updateChannel($event)">
</entity-attributes>

<entity-thumbnails>
</entity-thumbnails>

<entity-excerpt-note [excerpt]="(entity$ | async)?.excerpt"
                     [note]="(entity$ | async)?.internal_note"
                     (excerptChanged)="updateExcerpt($event)"
                     (noteChanged)="updateNote($event)">
</entity-excerpt-note>

<!-- Froala Editor -->
<!-- TODO: Use official one when ngModule bug is fixed -->
<!--<div *ngIf="inputPost" [froalaEditor]="froalaOptions"
     [(froalaModel)]="inputPost.content"></div>-->

<!-- We must use content$ | async instead of other code here, otherwise the
     post content is ether overwritten or empty -->
<froala [froalaOptions]="froalaOptions"
        [froalaData]="content$ | async"
        (model)="froalaContentChanged($event)"></froala>

<revision-history [entity]="entity$ | async"
                  [authorsObj]="authorsObj$ | async"
                  (restore2Revision)="restoreRevision($event)">
</revision-history>

<!-- Right panel, we can trigger a seperate saving individually -->
<right-panel [width]="'400px'" [isOpen]="openPanel"
             (toggle)="openPanel = !openPanel">
    <tabset>
        <tab heading="分类" [active]="tabIdx == 0">
            <div class="treeview">
                <category-tree [parentId]="0"
                               [categories]="cmsCategories$ | async"
                               [selectedCats]="(entity$ | async)?.categories"
                               (checkEvent)="updateCat($event)">
                </category-tree>
            </div>
        </tab>

        <tab heading="专题" [active]="tabIdx == 1">
            <topic-cloud [topicTypes]="topicTypes$ | async"
                         [topics]="topics$ | async"
                         [selectedTopics]="(entity$ | async)?.topics"
                         (searchTopic)="searchTopic($event)"
                         (addTopic)="addTopic($event)"
                         (removeTopic)="removeTopic($event)">
            </topic-cloud>
        </tab>

        <tab heading="Location" [active]="tabIdx == 2">
            <geo-location-cloud [locations]="geoLocations$ | async"
                                (clickEvent)="updateGeoLocation($event)">
            </geo-location-cloud>
        </tab>
    </tabset>
</right-panel>
