<div class="alert alert-danger">
    TODO: Evaluate ng2-uploader and ng2-file-upload for file upload
    TODO: Evaluate ng2-completer, ng2-select, angular2-select, ng2-auto-complete...
    TODO: Evaluate ng2-table, ng2-handsontable for future use.
    TODO: Evaluate angular2-tree-component, ng2-tree for
          setting of category, location, menu, etc.
</div>

<editor-page-header [slug]="'topic'"
                    [name]="'专题'"
                    [zh]="zh"
                    [previewUrl]="previewUrl"
                    [ids]="idsCurPage$ | async"
                    [entities]="entities$ | async"
                    [entity]="entity$ | async"
                    (cancelEdit)="cancelSave()">
</editor-page-header>

<div class="row">

    <!-- Sidebar -->
    <div class="col-xs-4" style="background: #e1f6fd; padding: 1rem">
        <entity-buttons [entityState]="(entity$ | async)?.state"
                        (save)="save()"
                        (save2Pending)="save2Pending()"
                        (save2Draft)="save2Draft()"
                        (save2Publish)="save2Publish()"
                        (cancelSave)="cancelSave()">
        </entity-buttons>


        <div class="date-area float-right" *ngIf="date">
            <span class="date-time btn btn-sm btn-secondary"
                  (click)="dpHidden = !dpHidden">
                显示时间(定时发布): {{ date | date: 'y-MM-dd HH:mm' }} GMT
                <i class="fa fa-chevron-down"
                   [class.fa-chevron-down]="dpHidden"
                   [class.fa-chevron-up]="!dpHidden"></i>
            </span>
            <div class="date-picker" [class.hidden]="dpHidden">
                <div>
                    <datepicker name="date"
                                [ngModel]="date"
                                (ngModelChange)="dateChange.emit($event)"
                                [showWeeks]="false"></datepicker>
                    <timepicker name="time"
                                [ngModel]="date"
                                (ngModelChange)="dateChange.emit($event)"
                                [showMeridian]="false"></timepicker>

                    <button class="btn btn-info btn-sm float-right"
                            (click)="dpHidden = true">确定</button>
                </div>

            </div>
        </div>

        <div class="form-group">
            <label>编辑</label>
            <ng-select [active]="(editor$ | async) ? [editor$ | async] : []"
                       [items]="editors$ | async"
                       (selected)="update('editor', $event)"
                       (removed)="update('editor', $event)"
                       placeholder="选择编辑"></ng-select>
        </div>

        <div class="form-group">
            <label>频道</label>
            <ng-select [active]="(channel$ | async) ? [channel$ | async] : []"
                       [items]="cmsChannels$ | async"
                       (selected)="update('channel', $event)"
                       (removed)="update('channel', $event)"
                       placeholder="专题频道"></ng-select>
        </div>

        <div class="form-group">
            <label>专题类型</label>
            <ng-select [active]="(topicType$ | async) ? [topicType$ | async] : []"
                       [items]="cmsTopicTypes$ | async"
                       (selected)="update('type', $event)"
                       (removed)="update('type', $event)"
                       placeholder="专题类型"></ng-select>
        </div>


        <!-- Topic location, category, topic, topic [product/topic/post] series etc -->
        <entity-attr-cloud [isTopic]="true"
                           [categories]="(entity$ | async)?.categories"
                           [location]="(entity$ | async)?.location"
                           [topics]="(entity$ | async)?.topics"
                           [topicTypes]="cmsTopicTypes$ | async"
                           (toggle)="tabIdx = $event; openPanel = !openPanel"
                           (detachCat)="detach('categories', $event)"
                           (detachTopic)="detach('topics', $event)"
                           (updateLocation)="update('location', $event)">
        </entity-attr-cloud>

        <div class="form-group">
            <label>关键字</label>
            <ng-select [active]="keywords$ | async"
                       [items]="keywords"
                       [multiple]="true"
                       (selected)="attachStr('keywords', $event)"
                       (removed)="detachStr('keywords', $event)"
                       placeholder="选择关键字"></ng-select>
        </div>

        <div class="form-group">
            <label>优惠专题</label>
            <input type="checkbox" class="form-control form-control-sm"
                   name="hasDeal" [ngModel]="hasDeal$ | async"
                   (ngModelChange)="update('has_deal', $event)"/>
        </div>

        <div class="alert alert-danger">
            TODO: We are going to put everthing here except title, main content
            edit area, such as datepicker, button, keywords, author, editor etc.
            We are going to use ng2-select in many items.
            TODO: We can genericalize the input/select with 1 or 2 template, and
            pass in different data only.
        </div>
    </div>

    <div class="col-xs-8">
        <entity-title-date [isTopic]="true"
                           [title]="(entity$ | async)?.title"
                           [guid]="(entity$ | async)?.guid"
                           [desc]="(entity$ | async)?.desc"
                           [anchorText]="(entity$ | async)?.anchor_text"
                           (titleChange)="update('title', $event)"
                           (guidChange)="update('guid', $event)"
                           (descChange)="update('desc', $event)"
                           (anchorTextChange)="update('anchor_text', $event)">
        </entity-title-date>

        <!-- Topic guid, anchor_text, website, aff_url -->
        <entity-permalink-edit [website]="(entity$ | async)?.website"
                               [affiliateUrl]="(entity$ | async)?.aff_url"
                               (websiteChange)="update('website', $event)"
                               (affiliateUrlChange)="update('aff_url', $event)">
        </entity-permalink-edit>


        <!-- Froala Editor -->
        <!-- TODO: Use official one when ngModule bug is fixed -->
        <!--<div *ngIf="inputPost" [froalaEditor]="froalaOptions"
             [(froalaModel)]="inputPost.content"></div>-->

        <h2 style="font-size: 1.25rem">专题首段介绍</h2>
        <froala [froalaOptions]="froalaSimplifiedOptions"
                [froalaData]="intro$ | async"
                (model)="froalaIntroChanged($event)"></froala>

        <h2 style="font-size: 1.25rem">专题正文内容</h2>
        <froala [froalaOptions]="froalaOptions"
                [froalaData]="content$ | async"
                (model)="froalaContentChanged($event)"></froala>

        <!-- Extra deal topic only data -->
        <deal-topic-content *ngIf="hasDeal$ | async"></deal-topic-content>
    </div>

</div>

<!-- Right panel, we can trigger a seperate saving individually -->
<right-panel [width]="'400px'" [isOpen]="openPanel"
             (toggle)="openPanel = !openPanel">
    <tabset>
        <tab heading="分类" [active]="tabIdx == 0">
            <div class="treeview">
                <category-tree [parentId]="0"
                               [categories]="cmsCategories$ | async"
                               [selectedCats]="(entity$ | async)?.categories"
                               (checkEvent)="toggleAttr('categories', $event)">
                </category-tree>
            </div>
        </tab>

        <tab heading="相关专题" [active]="tabIdx == 1">
            <topic-cloud [topicTypes]="cmsTopicTypes$ | async"
                         [topics]="cmsTopics$ | async"
                         [selectedTopics]="(entity$ | async)?.topics"
                         (searchTopic)="searchTopic(1, $event)"
                         (attachTopic)="attach('topics', $event)"
                         (detachTopic)="detach('topics', $event)">
            </topic-cloud>

            <div class="alert alert-danger">
                专题的专题需要分为几类来选择, 产品的品牌,网站,相关的产品,属于的知识类专题等,
                比如HB维他命C需要分别选择品牌专题: Holland Barrett, 产品系列专题: HB维他命系列,
                以及普通专题: 维他命, (还有网站专题: Holland Barrett网站??)
            </div>

            <div class="alert alert-danger">
                系列推荐包括专题包含的产品专题和文章专题推荐, 比如当当前专题为'brand'的时候,我们有一下的情况:
            </div>
            <ul>
                <li>推荐的产品系列: 用于显示返利购买链接, 从所有cms_topics.type为'products'的专题当中选择</li>
                <li>推荐的产品系列,用于正文的相关从属关系推荐, 从所有cms_topics.type为'products'的专题当中选择</li>
                <li>用于推荐文章的交叉专题, 从所有cms_topics.type为'general'的专题当中选择</li>
            </ul>

            <div class="alert alert-danger">
                系列推荐包括专题包含的产品专题和文章专题推荐, 比如当当前专题为'products'的时候,我们有一下的情况:
            </div>
            <ul>
                <li>推荐本系列的产品: 用于显示返利购买链接, 从所有cms_topics.type为'product'的专题当中选择</li>
                <li>推荐本系列的产品,用于正文的相关从属关系推荐, 从所有cms_topics.type为'product'的专题当中选择</li>
                <li>推荐同一品牌相关的产品系列,用于正文的相关从属关系推荐, 从相同'brand'的所有cms_topics.type为'products'的专题当中选择</li>
                <li>推荐不同品牌相同功能的产品系列,用于正文的相关从属关系推荐, 从不同'brand'和cms_topics.type==='general', 并且当前产品系列所关联的所有general topic的'products' topics当中选择,
                    比如, HB鱼油系列专题, 正文推荐专题会显示Natural Aids鱼油系列。
                </li>
                <li>用于推荐文章的交叉专题, 从所有cms_topics.type为'general'的专题当中选择</li>
            </ul>
        </tab>

        <tab heading="Location" [active]="tabIdx == 2">
            <geo-location-cloud [locations]="geoLocations$ | async"
                                (clickEvent)="update('location', $event)">
            </geo-location-cloud>
        </tab>

    </tabset>
</right-panel>

<pre>
    This page should have following entries:
    1. cms topic related stuff
    2. Manage cms post related to this topic
    3. Manage deal post related to this topic
    4. Manage topic deal content of this topic, we have auto generated template
       for this, such as xxx的优惠, xxx折扣, xxx打折信息
    5. deal topic option is default enabled for topic in shopping category, so
       at least we have placeholder page stands for search engine ranking, as
       we will automatically generate deal post for deal topic.
</pre>
<h2>This is topic</h2>
